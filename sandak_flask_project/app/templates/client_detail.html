{% extends 'layout.html' %}
{% block title %}تفاصيل العميل{% endblock %}
{% block content %}
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('main.clients') }}">العملاء</a></li>
      <li class="breadcrumb-item active" aria-current="page">تفاصيل العميل</li>
    </ol>
  </nav>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">{{ client.name }}</h5>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('main.clients') }}">رجوع</a>
  </div>

  <div class="row g-3">
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-white">وسائل التواصل</div>
        <div class="card-body">
          {% for ct in contacts %}
            <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
              <div>
                <div class="fw-semibold">{{ ct.kind }}</div>
                <div class="text-muted small">{{ ct.value }}</div>
              </div>
              {% if ct.is_primary %}<span class="badge bg-success">رئيسية</span>{% endif %}
            </div>
          {% else %}
            <div class="text-muted">لا توجد وسائل اتصال</div>
          {% endfor %}
          <form class="mt-3" method="post" action="{{ url_for('main.client_add_contact', client_id=client.id) }}">
            <div class="row g-2">
              <div class="col-4">
                <select class="form-select form-select-sm" name="kind">
                  <option value="phone">هاتف</option>
                  <option value="whatsapp">واتساب</option>
                  <option value="email">بريد</option>
                </select>
              </div>
              <div class="col-8">
                <input class="form-control form-control-sm" name="value" placeholder="القيمة" required>
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="is_primary" id="primaryContact">
                  <label class="form-check-label" for="primaryContact">تعيين كرئيسية</label>
                </div>
              </div>
              <div class="col-12">
                <button class="btn btn-sm btn-primary" type="submit">إضافة</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-white">ملاحظات</div>
        <div class="card-body">
          <form class="mb-3" method="post" action="{{ url_for('main.client_add_note', client_id=client.id) }}">
            <textarea class="form-control" name="content" rows="3" placeholder="أضف ملاحظة" required></textarea>
            <div class="text-end mt-2">
              <button class="btn btn-sm btn-primary" type="submit">حفظ</button>
            </div>
          </form>
          {% for n in notes %}
            <div class="border rounded p-2 mb-2">
              <div class="small text-muted">{{ n.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
              <div>{{ n.content }}</div>
            </div>
          {% else %}
            <div class="text-muted">لا توجد ملاحظات</div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-white">تاريخ المعاملات</div>
        <div class="card-body">
          <form class="row g-2 mb-3" method="get">
            <div class="col-6">
              <input type="date" class="form-control form-control-sm" name="date_from" value="{{ date_from or '' }}">
            </div>
            <div class="col-6">
              <input type="date" class="form-control form-control-sm" name="date_to" value="{{ date_to or '' }}">
            </div>
            <div class="col-12">
              <input class="form-control form-control-sm" name="tx_type" placeholder="نوع المعاملة" value="{{ tx_type or '' }}">
            </div>
            <div class="col-12">
              <button class="btn btn-outline-primary btn-sm w-100" type="submit">تصفية</button>
            </div>
          </form>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>نوع المعاملة</th>
                  <th>الحالة</th>
                  <th>تاريخ</th>
                </tr>
              </thead>
              <tbody>
                {% for t in tx_items %}
                <tr>
                  <td>{{ t.service_type }}</td>
                  <td>{{ t.status }}</td>
                  <td class="text-muted small">{{ t.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                </tr>
                {% else %}
                <tr><td colspan="3" class="text-center text-muted">لا توجد معاملات</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

